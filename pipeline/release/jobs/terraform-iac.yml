# pipeline/release/terraform-iac.yml
parameters:
- name: environment
  type: string
  default: 'dev'
  values:
    - dev
    - qa
    - prod

steps:
  - checkout: self

  - task: Bash@3
    displayName: 'Terraform init + validate (${{ parameters.environment }})'
    inputs:
      targetType: 'inline'
      script: |
        set -e
        ENV="${{ parameters.environment }}"
        IAC_DIR="iac/${ENV}"

        echo "Using IaC directory: ${IAC_DIR}"
        cd $(Build.SourcesDirectory)/${IAC_DIR}

        terraform init
        terraform fmt -check
        terraform validate

  - task: Bash@3
    displayName: 'Terraform plan (${{ parameters.environment }})'
    inputs:
      targetType: 'inline'
      script: |
        set -e
        ENV="${{ parameters.environment }}"
        IAC_DIR="iac/${ENV}"
        TFVARS_FILE="${ENV}.tfvars"

        cd $(Build.SourcesDirectory)/${IAC_DIR}

        echo "Using tfvars: ${TFVARS_FILE}"
        terraform plan -var-file=${TFVARS_FILE} -out=plan.tfplan

  # En dev se puede aplicar directo; en qa/prod típicamente lo amarro a aprobación manual
  - ${{ if eq(parameters.environment, 'dev') }}:
    - task: Bash@3
      displayName: 'Terraform apply (dev)'
      inputs:
        targetType: 'inline'
        script: |
          set -e
          ENV="${{ parameters.environment }}"
          IAC_DIR="iac/${ENV}"

          cd $(Build.SourcesDirectory)/${IAC_DIR}
          terraform apply -auto-approve plan.tfplan
