parameters:
- name: environment
  type: string
  default: 'dev'
  values:
    - dev
    - qa
    - prod

- name: imageTag
  type: string

steps:
  - checkout: self
    persistCredentials: true

  - task: Bash@3
    displayName: 'Update image.tag in GitOps values file'
    inputs:
      targetType: 'inline'
      script: |
        set -e
        ENV="${{ parameters.environment }}"
        TAG="${{ parameters.imageTag }}"

        case "${ENV}" in
          dev)  VALUES_FILE="gitops/envs/dev/values-dev.yaml" ;;
          qa)   VALUES_FILE="gitops/envs/qa/values-qa.yaml" ;;
          prod) VALUES_FILE="gitops/envs/prod/values-prod.yaml" ;;
          *)    echo "Unknown environment: ${ENV}"; exit 1 ;;
        esac

        cd $(Build.SourcesDirectory)

        echo "Updating image.tag to ${TAG} in ${VALUES_FILE}"
        yq -i ".image.tag = \"${TAG}\"" "${VALUES_FILE}"

        git config user.email "ci@satrack.local"
        git config user.name  "CI Pipeline"

        git status
        git add "${VALUES_FILE}"
        git commit -m "chore(gitops): update image.tag to ${TAG} (${ENV})" || echo "No changes to commit"
        git push || echo "Nothing to push (no changes)"
